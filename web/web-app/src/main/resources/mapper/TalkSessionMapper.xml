<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.atguigu.lease.web.app.mapper.TalkSessionMapper">

    <!-- 获取会话列表 -->
    <select id="selectSessionList" resultType="com.atguigu.lease.web.app.vo.message.TalkSessionVo">
        SELECT
        s.id,
        s.target_user_id AS targetUserId,
        u.nickname AS targetNickname,
        COALESCE(u.avatar_url, 'https://fastly.jsdelivr.net/npm/@vant/assets/cat.jpeg') AS targetAvatar,
        s.last_message AS lastMessage,
        s.unread_count AS unreadCount,
        s.last_time AS lastTime
        FROM
        talk_session s
        LEFT JOIN
        user_info u ON s.target_user_id = u.id
        WHERE
        s.user_id = #{userId}
        AND s.is_deleted = 0
        <if test="keyword != null and keyword != ''">
            AND u.nickname LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY
        s.last_time DESC
    </select>

    <!-- 获取或创建会话 -->
    <select id="getOrCreateSession" resultType="com.atguigu.lease.model.entity.TalkSession">
        SELECT
            *
        FROM
            talk_session
        WHERE
            user_id = #{userId}
          AND target_user_id = #{targetUserId}
          AND is_deleted = 0
            LIMIT 1
    </select>

    <!-- 更新会话最后消息和未读数 -->
    <update id="updateSessionLastMessage">
        UPDATE talk_session
        SET
        last_message = #{lastMessage},
        last_time = NOW(),
        <if test="incrementUnread">
            unread_count = unread_count + 1,
        </if>
        update_time = NOW()
        WHERE
        user_id = #{userId}
        AND target_user_id = #{targetUserId}
        AND is_deleted = 0
    </update>

    <!-- 重置未读计数 -->
    <update id="resetUnreadCount">
        UPDATE talk_session
        SET
            unread_count = 0,
            update_time = NOW()
        WHERE
            user_id = #{userId}
          AND target_user_id = #{targetUserId}
          AND is_deleted = 0
    </update>
</mapper>
